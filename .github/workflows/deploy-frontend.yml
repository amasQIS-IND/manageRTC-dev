name: Deploy Frontend

on:
  push:
    branches: [ main ]
    paths:
      - "react/**"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch:

env:
  DEPLOY_PATH: /var/www/dev.manage-rtc.com/frontend
  BACKUP_PATH: /home/deploy/backups
  FRONTEND_URL: https://dev.manage-rtc.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: react

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Write .env.production
        run: |
          cat > .env.production << 'EOF'
          CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY_PUBLIC }}
          REACT_APP_BACKEND_URL=https://apidev.manage-rtc.com
          EOF

      - name: Install & build
        env:
          CI: false
        run: |
          npm ci
          npm run build

      - name: Upload build to VPS (temp)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "react/build/**"
          target: "/home/${{ secrets.VPS_USER }}/frontend_release/"
          strip_components: 1

      - name: Backup current deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            mkdir -p ~/backups
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            if [ -d "/var/www/dev.manage-rtc.com/frontend" ]; then
              echo "Creating backup: frontend-$TIMESTAMP.tar.gz"
              tar -czf ~/backups/frontend-$TIMESTAMP.tar.gz \
                -C /var/www/dev.manage-rtc.com/frontend \
                .
              # Keep only last 5 backups
              ls -t ~/backups/frontend-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f
              echo "Backup completed. Current backups:"
              ls -la ~/backups/frontend-*.tar.gz 2>/dev/null || echo "No backups found"
            else
              echo "No existing deployment to backup"
            fi

      - name: Activate on VPS (/var/www/dev.manage-rtc.com/frontend)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            mkdir -p /var/www/dev.manage-rtc.com/frontend
            rm -rf /var/www/dev.manage-rtc.com/frontend/*
            # copy the CONTENTS of build/ so index.html is at the root
            cp -r ~/frontend_release/build/* /var/www/dev.manage-rtc.com/frontend/
            find /var/www/dev.manage-rtc.com/frontend -type f -name "*.map" -delete
            sudo systemctl reload nginx

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            echo "Running frontend health check..."

            # Check nginx is running
            if ! systemctl is-active --quiet nginx; then
              echo "ERROR: nginx is not running!"
              sudo systemctl status nginx
              exit 1
            fi

            # Check if index.html exists
            if [ ! -f "/var/www/dev.manage-rtc.com/frontend/index.html" ]; then
              echo "ERROR: index.html not found in deployment directory!"
              ls -la /var/www/dev.manage-rtc.com/frontend/
              exit 1
            fi

            # HTTP health check (with retry)
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:80/)
              if echo "$HTTP_CODE" | grep -qE "^(200|301|302|304)$"; then
                echo "Health check passed! HTTP status: $HTTP_CODE"
                echo "Frontend successfully deployed at: https://dev.manage-rtc.com"
                exit 0
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Health check attempt $RETRY_COUNT failed (HTTP: $HTTP_CODE), retrying..."
              sleep 3
            done

            echo "WARNING: Health check did not return expected status after $MAX_RETRIES attempts"
            echo "Checking nginx error logs..."
            sudo tail -n 20 /var/log/nginx/error.log
            exit 1
